import React, { useState } from 'react';
import {
    Box,
    Card,
    CardContent,
    Typography,
    Grid,
    Paper,
    Alert,
    Stack
} from '@mui/material';
import PsychologyIcon from '@mui/icons-material/Psychology';
import BigFiveRadarChart from './BigFiveRadarChart';
import DiscProfileDisplay from './DiscProfileDisplay';
import SchwartzValuesList from './SchwartzValuesList';
import CustomerArchetypeDisplay from './CustomerArchetypeDisplay';


const PsychometricDashboard = ({ 
    analysisData, 
    loading = false, 
    isPolling = false, 
    attempts = 0, 
    maxAttempts = 12,
    interactionId = null,
    onClarificationAnswered = null,
    // üß†‚ö° ULTRA M√ìZG v4.2.0: NOWE PROPSY
    cumulativePsychology = null,  // cumulative_psychology z sesji
    isPsychologyReady = false,    // Czy profil psychologiczny jest gotowy
    dnaKlienta = null,           // holistic_psychometric_profile z sesji
    isDnaReady = false           // Czy DNA jest gotowe
}) => {
    const [submitting, setSubmitting] = useState(false);
    
    // Stan ≈Çadowania
    if (loading) {
        return (
            <Card>
                <CardContent sx={{ textAlign: 'center', py: 4 }}>
                    <PsychologyIcon sx={{ fontSize: 48, mb: 2, color: 'primary.main' }} />
                    <Typography variant="h6" gutterBottom>
                        Analiza Psychometryczna w Toku...
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                        AI analizuje profil psychologiczny klienta
                    </Typography>
                </CardContent>
            </Card>
        );
    }

    // üß†‚ö° LOGIKA DECYZYJNA ULTRA M√ìZGU v4.2.0
    // Priorytetyzuj dane z nowej architektury backendu
    let activePsychology, isUsingUltraBrain;

    if (isPsychologyReady && cumulativePsychology) {
        // ULTRA M√ìZG v4.2.0: U≈ºywamy cumulative_psychology z sesji
        activePsychology = cumulativePsychology;
        isUsingUltraBrain = true;
        console.log('üß†‚ö° [PSYCHOMETRIC DASHBOARD v4.2.0] U≈ºywam danych z nowej architektury:', cumulativePsychology);
    } else {
        // LEGACY: U≈ºywamy analysisData.cumulative_psychology
        activePsychology = analysisData?.cumulative_psychology || {};
        isUsingUltraBrain = false;
        console.log('üß† [PSYCHOMETRIC DASHBOARD] U≈ºywam legacy danych:', analysisData?.cumulative_psychology);
    }

    // KALIBRACJA: Okre≈õl poziom analizy
    const analysisLevel = analysisData?.analysis_level || 'pe≈Çna'; // Domy≈õlnie pe≈Çna dla kompatybilno≈õci wstecznej
    const isPreliminaryAnalysis = analysisLevel === 'wstƒôpna';
    const interactionCount = analysisData?.interaction_count || 0;

    console.log('üéØ [ANALYSIS LEVEL] Poziom analizy:', analysisLevel, 'Wstƒôpna:', isPreliminaryAnalysis, 'Interakcje:', interactionCount);
    
    // Debug logging
    console.log('PsychometricDashboard v4.2.0 - analysisData:', analysisData);
    console.log('PsychometricDashboard v4.2.0 - activePsychology:', activePsychology);
    console.log('PsychometricDashboard v4.2.0 - isUsingUltraBrain:', isUsingUltraBrain);
    console.log('PsychometricDashboard v4.2.0 - has big_five:', !!activePsychology?.big_five);
    console.log('PsychometricDashboard v4.2.0 - has disc:', !!activePsychology?.disc);
    console.log('PsychometricDashboard v4.2.0 - has schwartz:', !!activePsychology?.schwartz_values);

    // Brak danych (legacy lub Ultra M√≥zg)
    if (!analysisData && !isUsingUltraBrain) {
        return (
            <Card>
                <CardContent sx={{ textAlign: 'center', py: 4 }}>
                    <PsychologyIcon sx={{ fontSize: 48, mb: 2, color: 'text.secondary' }} />
                    <Typography variant="h6" gutterBottom color="text.secondary">
                        Profil Psychometryczny
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                        {isUsingUltraBrain ? 
                            'Ultra M√≥zg v4.2.0 przygotowuje szczeg√≥≈ÇowƒÖ analizƒô psychologicznƒÖ...' :
                            'Oczekiwanie na dane do analizy psychologicznej...'
                        }
                    </Typography>
                </CardContent>
            </Card>
        );
    }

    // ‚úÖ ULTRA M√ìZG v4.2.0: Sprawdzenie danych z activePsychology (priorytet dla nowej architektury)
    const hasBigFive = activePsychology?.big_five && Object.keys(activePsychology.big_five).length > 0;
    const hasDisc = activePsychology?.disc && Object.keys(activePsychology.disc).length > 0;
    const hasSchwartz = activePsychology?.schwartz_values && Array.isArray(activePsychology.schwartz_values) && activePsychology.schwartz_values.length > 0;

    // üîç SZCZEG√ì≈ÅOWY DEBUG: Sprawd≈∫my strukturƒô danych (Ultra M√≥zg v4.2.0)
    console.log('üîç [FULL DATA v4.2.0] analysisData:', analysisData);
    console.log('üîç [ACTIVE PSYCHOLOGY v4.2.0] activePsychology:', activePsychology);
    console.log('üîç [BIG FIVE] raw data:', activePsychology?.big_five);
    console.log('üîç [DISC] raw data:', activePsychology?.disc);
    console.log('üîç [SCHWARTZ] raw data:', activePsychology?.schwartz_values);
    console.log('üîç [ARCHETYPE] customer_archetype:', analysisData?.customer_archetype);
    console.log('üîç [FLAGS] hasBigFive:', hasBigFive, 'hasDisc:', hasDisc, 'hasSchwartz:', hasSchwartz);
    console.log('üß†‚ö° [SOURCE] isUsingUltraBrain:', isUsingUltraBrain);

    // USUNIƒòTO: Przestarza≈Çy komponent ClarifyingQuestions - funkcjonalno≈õƒá przeniesiona do Ultra M√≥zgu

    if (!hasBigFive && !hasDisc && !hasSchwartz) {
        return (
            <Card>
                <CardContent sx={{ textAlign: 'center', py: 4 }}>
                    <PsychologyIcon sx={{ fontSize: 48, mb: 2, color: 'warning.main' }} />
                    <Typography variant="h6" gutterBottom color="text.secondary">
                        Profil Psychometryczny
                    </Typography>
                    <Typography variant="body2" color="text.secondary">
                        Analiza psychometryczna w toku...
                    </Typography>
                    
                    {/* KROK 2: Polling Status */}
                    {isPolling && (
                        <Alert severity="info" sx={{ mt: 2, textAlign: 'left' }}>
                            <Typography variant="body2">
                                üîÑ <strong>Czekam na AI:</strong> Pr√≥ba {attempts}/{maxAttempts}
                                <br />
                                üí° System automatycznie odpytuje backend co 5 sekund...
                            </Typography>
                        </Alert>
                    )}
                    
                    {!isPolling && attempts > 0 && (
                        <Alert severity="warning" sx={{ mt: 2, textAlign: 'left' }}>
                            <Typography variant="body2">
                                ‚è∞ <strong>Limit pr√≥b osiƒÖgniƒôty:</strong> {attempts}/{maxAttempts}
                                <br />
                                üîÑ Spr√≥buj od≈õwie≈ºyƒá lub utworzyƒá nowƒÖ interakcjƒô
                            </Typography>
                        </Alert>
                    )}
                </CardContent>
            </Card>
        );
    }

    // G≈Ç√≥wny dashboard z analizƒÖ
    return (
        <Box>
            {/* Header z Ultra M√≥zg Badge */}
            <Paper elevation={1} sx={{ p: 2, mb: 3, bgcolor: 'primary.main', color: 'primary.contrastText', position: 'relative' }}>
                <Box display="flex" alignItems="center" gap={2}>
                    <PsychologyIcon sx={{ fontSize: 32 }} />
                    <Box sx={{ flexGrow: 1 }}>
                        <Typography variant="h6" component="h2">
                            Profil Psychometryczny Klienta
                        </Typography>
                        <Typography variant="body2" sx={{ opacity: 0.9 }}>
                            {isUsingUltraBrain ? 
                                'üß†‚ö° Ultra M√≥zg: Big Five ‚Ä¢ DISC ‚Ä¢ Warto≈õci Schwartza' :
                                'Analiza AI: Big Five ‚Ä¢ DISC ‚Ä¢ Warto≈õci Schwartza'
                            }
                        </Typography>
                    </Box>
                    {isUsingUltraBrain && (
                        <Box sx={{
                            position: 'absolute',
                            top: -8,
                            right: 16,
                            bgcolor: 'secondary.main',
                            color: 'secondary.contrastText',
                            px: 1.5,
                            py: 0.5,
                            borderRadius: 2,
                            fontSize: '0.75rem',
                            fontWeight: 'bold'
                        }}>
                            üß†‚ö° ULTRA M√ìZG
                        </Box>
                    )}

                    {/* KALIBRACJA: Komunikat o poziomie analizy */}
                    {isPreliminaryAnalysis && (
                        <Box sx={{
                            position: 'absolute',
                            bottom: -8,
                            left: 16,
                            bgcolor: 'warning.main',
                            color: 'warning.contrastText',
                            px: 1.5,
                            py: 0.5,
                            borderRadius: 2,
                            fontSize: '0.75rem',
                            fontWeight: 'bold'
                        }}>
                            üìä ANALIZA WSTƒòPNA ({interactionCount} interakcji)
                        </Box>
                    )}
                </Box>
            </Paper>

            {/* üöÄ ULTRA M√ìZG v4.1 - ARCHETYP KLIENTA TESLI */}
            {analysisData?.customer_archetype && (
                <Box sx={{ mb: 3 }}>
                    <CustomerArchetypeDisplay
                        customerArchetype={analysisData.customer_archetype}
                        psychologyConfidence={analysisData.psychology_confidence || 0}
                        loading={loading}
                        dnaKlienta={dnaKlienta}
                        isDnaReady={isDnaReady}
                    />
                </Box>
            )}

            {/* ‚úÖ G≈Å√ìWNE SEKCJE ANALIZY - Z WARUNKAMI RENDERINGU */}
            <Grid container spacing={3}>
                {/* Big Five Radar Chart */}
                {hasBigFive && (
                    <Grid item xs={12} md={6}>
                        <Card elevation={2}>
                            <CardContent>
                                <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    üìä Model Big Five
                                </Typography>
                                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                                    Piƒôƒá g≈Ç√≥wnych wymiar√≥w osobowo≈õci
                                </Typography>
                                <BigFiveRadarChart data={activePsychology?.big_five} />
                            </CardContent>
                        </Card>
                    </Grid>
                )}

                {/* DISC Profile */}
                {hasDisc && (
                    <Grid item xs={12} md={6}>
                        <Card elevation={2}>
                            <CardContent>
                                <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    üé≠ Profil DISC
                                </Typography>
                                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                                    Style zachowania i komunikacji
                                </Typography>
                                <DiscProfileDisplay data={activePsychology?.disc} />
                            </CardContent>
                        </Card>
                    </Grid>
                )}

                {/* Schwartz Values */}
                {hasSchwartz && (
                    <Grid item xs={12}>
                        <Card elevation={2}>
                            <CardContent>
                                <Typography variant="h6" gutterBottom sx={{ display: 'flex', alignItems: 'center', gap: 1 }}>
                                    üíé Warto≈õci Schwartza
                                </Typography>
                                <Typography variant="body2" color="text.secondary" sx={{ mb: 2 }}>
                                    Kluczowe motywacje i systemy warto≈õci klienta
                                </Typography>
                                <SchwartzValuesList data={activePsychology?.schwartz_values} />
                            </CardContent>
                        </Card>
                    </Grid>
                )}
            </Grid>

            {/* KALIBRACJA: Komunikat o analizie wstƒôpnej */}
            {isPreliminaryAnalysis && (
                <Alert severity="warning" sx={{ mt: 3 }}>
                    <Typography variant="body2">
                        ‚ö†Ô∏è <strong>Analiza wstƒôpna:</strong> Profil zosta≈Ç utworzony na podstawie {interactionCount} interakcji.
                        Dodaj wiƒôcej obserwacji, aby zwiƒôkszyƒá precyzjƒô analizy psychologicznej i uzyskaƒá bardziej trafne strategie sprzeda≈ºowe.
                    </Typography>
                </Alert>
            )}

            {/* Informacja o ≈∫r√≥dle analizy */}
            <Alert severity="info" sx={{ mt: isPreliminaryAnalysis ? 1 : 3 }}>
                <Typography variant="body2">
                    üí° <strong>Wskaz√≥wka:</strong> Najed≈∫ myszƒÖ na elementy wizualizacji aby zobaczyƒá
                    szczeg√≥≈Çowe strategie sprzeda≈ºowe dostosowane do profilu klienta.
                </Typography>
            </Alert>
        </Box>
    );
};

export default PsychometricDashboard;
